å®Œæ•´çš„AIé©±åŠ¨ISOæ–‡æ¡£ç”Ÿæˆpipelineã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†çš„æŠ€æœ¯æ¶æ„å’Œå®ç°æ–¹æ¡ˆï¼š

## **ç³»ç»Ÿæ¶æ„è®¾è®¡**

### **Pipeline Overview**
```
Video Input + Metadata â†’ Video Analysis â†’ Information Extraction â†’ Document Generation â†’ ISO Compliance Check â†’ Final Output
```

## **æ ¸å¿ƒPipelineç»„ä»¶**

### **1. æ•°æ®è¾“å…¥å±‚ (Input Layer)**
```python
# è¾“å…¥æ•°æ®ç»“æ„
class InputData:
    video_file: str          # æ“ä½œè§†é¢‘æ–‡ä»¶
    machine_id: str          # æœºå™¨ID
    part_id: str            # é›¶ä»¶ID  
    material_id: str        # ææ–™ID
    process_id: str         # å·¥åºID
    process_number: int     # å·¥åºå·
    operator_info: dict     # æ“ä½œå‘˜ä¿¡æ¯
    quality_standards: dict # è´¨é‡æ ‡å‡†
    safety_requirements: list # å®‰å…¨è¦æ±‚
```

### **2. è§†é¢‘åˆ†ææ¨¡å— (Video Analysis)**
```python
class VideoAnalysisEngine:
    def __init__(self):
        self.gemini_client = GeminiClient()
        self.frame_extractor = FrameExtractor()
        self.action_detector = ActionDetector()
    
    def analyze_video(self, video_path, metadata):
        # å…³é”®å¸§æå–
        key_frames = self.extract_key_frames(video_path)
        
        # Geminiè§†é¢‘åˆ†æ
        analysis_result = self.gemini_client.analyze_video(
            video_path, 
            prompt=self.build_analysis_prompt(metadata)
        )
        
        # æ“ä½œæ­¥éª¤è¯†åˆ«
        operation_steps = self.extract_operation_steps(analysis_result)
        
        # è´¨æ£€ç‚¹è¯†åˆ«
        quality_checkpoints = self.identify_quality_points(analysis_result)
        
        return {
            'key_frames': key_frames,
            'operation_steps': operation_steps,
            'quality_checkpoints': quality_checkpoints,
            'safety_observations': analysis_result.safety_notes
        }
```

### **3. ä¿¡æ¯ç»“æ„åŒ–æ¨¡å— (Information Processing)**
```python
class InformationProcessor:
    def __init__(self):
        self.llm_client = LLMClient()  # æœ¬åœ°LLMæˆ–API
        
    def structure_information(self, video_analysis, metadata):
        # æ„å»ºç»“æ„åŒ–æ“ä½œæµç¨‹
        structured_process = {
            'process_overview': self.generate_overview(metadata),
            'prerequisites': self.extract_prerequisites(video_analysis),
            'step_by_step_instructions': self.format_instructions(video_analysis.operation_steps),
            'quality_control_points': self.format_qc_points(video_analysis.quality_checkpoints),
            'safety_procedures': self.format_safety_procedures(video_analysis.safety_observations),
            'troubleshooting': self.generate_troubleshooting_guide(metadata),
            'documentation_requirements': self.define_documentation_needs(metadata)
        }
        
        return structured_process
```

### **4. æ–‡æ¡£ç”Ÿæˆå¼•æ“ (Document Generation)**
```python
class ISODocumentGenerator:
    def __init__(self):
        self.template_engine = TemplateEngine()
        self.image_processor = ImageProcessor()
        self.pdf_generator = PDFGenerator()
        
    def generate_iso_document(self, structured_info, key_frames):
        # ISOæ¨¡æ¿é€‰æ‹©
        template = self.select_iso_template(structured_info.process_type)
        
        # å›¾åƒå¤„ç†å’Œå¸ƒå±€
        processed_images = self.process_key_frames(key_frames)
        
        # æ–‡æ¡£å†…å®¹ç”Ÿæˆ
        document_content = self.compile_document_content(
            structured_info, 
            processed_images
        )
        
        # PDFç”Ÿæˆ
        pdf_document = self.pdf_generator.create_pdf(
            content=document_content,
            template=template,
            compliance_check=True
        )
        
        return pdf_document
```

## **è¯¦ç»†å®ç°æ–¹æ¡ˆ**

### **Phase 1: è§†é¢‘åˆ†æä¸ä¿¡æ¯æå–**

```python
# Geminiåˆ†ææç¤ºè¯æ¨¡æ¿
ANALYSIS_PROMPT = """
åˆ†æè¿™ä¸ªå·¥ä¸šæ“ä½œè§†é¢‘ï¼Œæå–ä»¥ä¸‹ä¿¡æ¯ï¼š

è®¾å¤‡ä¿¡æ¯ï¼š
- æœºå™¨ID: {machine_id}
- é›¶ä»¶ID: {part_id}
- å·¥åº: {process_id} (ç¬¬{process_number}æ­¥)

è¯·è¯†åˆ«å¹¶æè¿°ï¼š
1. è¯¦ç»†æ“ä½œæ­¥éª¤ï¼ˆæŒ‰æ—¶é—´é¡ºåºï¼‰
2. å…³é”®è´¨æ£€ç‚¹å’Œæ£€æŸ¥æ–¹æ³•
3. å®‰å…¨æ³¨æ„äº‹é¡¹
4. å·¥å…·å’Œææ–™ä½¿ç”¨
5. æ½œåœ¨é£é™©ç‚¹
6. æ“ä½œæ ‡å‡†å’Œè¦æ±‚

è¾“å‡ºæ ¼å¼ï¼šç»“æ„åŒ–JSON
"""

class GeminiVideoAnalyzer:
    def analyze_manufacturing_video(self, video_path, metadata):
        prompt = ANALYSIS_PROMPT.format(**metadata)
        
        response = self.gemini_client.generate_content([
            {"mime_type": "video/mp4", "data": video_path},
            prompt
        ])
        
        return self.parse_gemini_response(response)
```

### **Phase 2: å…³é”®å¸§æå–ä¸å›¾åƒå¤„ç†**

```python
class KeyFrameExtractor:
    def extract_operation_frames(self, video_path, operation_steps):
        cap = cv2.VideoCapture(video_path)
        key_frames = []
        
        for step in operation_steps:
            # åŸºäºæ—¶é—´æˆ³æå–å…³é”®å¸§
            frame_time = step['timestamp']
            cap.set(cv2.CAP_PROP_POS_MSEC, frame_time * 1000)
            ret, frame = cap.read()
            
            if ret:
                # å›¾åƒå¢å¼ºå’Œæ ‡æ³¨
                annotated_frame = self.annotate_frame(frame, step)
                key_frames.append({
                    'step_id': step['id'],
                    'image': annotated_frame,
                    'description': step['description'],
                    'timestamp': frame_time
                })
        
        return key_frames
    
    def annotate_frame(self, frame, step_info):
        # æ·»åŠ æ“ä½œåŒºåŸŸæ ‡æ³¨
        # æ·»åŠ å®‰å…¨æç¤ºæ ‡æ³¨
        # æ·»åŠ è´¨æ£€ç‚¹æ ‡æ³¨
        return annotated_frame
```

### **Phase 3: ISOæ–‡æ¡£æ¨¡æ¿ç³»ç»Ÿ**

```python
class ISOTemplateManager:
    def __init__(self):
        self.templates = {
            'ISO_9001_SOP': 'templates/iso9001_sop.html',
            'ISO_14001_ENV': 'templates/iso14001_env.html',
            'ISO_45001_SAFETY': 'templates/iso45001_safety.html'
        }
    
    def generate_document_structure(self, process_type):
        return {
            'header': self.generate_header(),
            'document_control': self.generate_document_control(),
            'scope_and_purpose': self.generate_scope(),
            'responsibilities': self.generate_responsibilities(),
            'procedure_steps': self.generate_procedure_section(),
            'quality_records': self.generate_quality_section(),
            'references': self.generate_references(),
            'appendices': self.generate_appendices()
        }
```

### **Phase 4: å®Œæ•´Pipelineå®ç°**

```python
class ISODocumentPipeline:
    def __init__(self):
        self.video_analyzer = GeminiVideoAnalyzer()
        self.frame_extractor = KeyFrameExtractor()
        self.info_processor = InformationProcessor()
        self.doc_generator = ISODocumentGenerator()
        self.quality_checker = QualityAssuranceChecker()
    
    def process(self, video_file, metadata):
        try:
            # Step 1: è§†é¢‘åˆ†æ
            print("ğŸ¥ åˆ†ææ“ä½œè§†é¢‘...")
            video_analysis = self.video_analyzer.analyze_manufacturing_video(
                video_file, metadata
            )
            
            # Step 2: å…³é”®å¸§æå–
            print("ğŸ“¸ æå–å…³é”®æ“ä½œå¸§...")
            key_frames = self.frame_extractor.extract_operation_frames(
                video_file, video_analysis['operation_steps']
            )
            
            # Step 3: ä¿¡æ¯ç»“æ„åŒ–
            print("ğŸ“‹ ç»“æ„åŒ–æ“ä½œä¿¡æ¯...")
            structured_info = self.info_processor.structure_information(
                video_analysis, metadata
            )
            
            # Step 4: æ–‡æ¡£ç”Ÿæˆ
            print("ğŸ“„ ç”ŸæˆISOæ–‡æ¡£...")
            iso_document = self.doc_generator.generate_iso_document(
                structured_info, key_frames
            )
            
            # Step 5: è´¨é‡æ£€æŸ¥
            print("âœ… ISOåˆè§„æ€§æ£€æŸ¥...")
            compliance_report = self.quality_checker.validate_document(
                iso_document, metadata['iso_standard']
            )
            
            return {
                'document': iso_document,
                'compliance_report': compliance_report,
                'metadata': {
                    'generated_at': datetime.now(),
                    'process_id': metadata['process_id'],
                    'version': '1.0'
                }
            }
            
        except Exception as e:
            return {'error': str(e), 'status': 'failed'}
```

## **éƒ¨ç½²æ¶æ„å»ºè®®**

### **æŠ€æœ¯æ ˆé€‰æ‹©**
- **è§†é¢‘åˆ†æ**: Gemini Pro Vision API
- **æœ¬åœ°LLM**: Llama 3.1 8B (ç”¨äºæ–‡æœ¬å¤„ç†)
- **å›¾åƒå¤„ç†**: OpenCV + PIL
- **æ–‡æ¡£ç”Ÿæˆ**: WeasyPrint + Jinja2
- **APIæ¡†æ¶**: FastAPI
- **å®¹å™¨åŒ–**: Docker + Docker Compose

### **ç³»ç»Ÿéƒ¨ç½²**
```yaml
# docker-compose.yml
version: '3.8'
services:
  iso-pipeline:
    build: .
    ports:
      - "8000:8000"
    volumes:
      - ./videos:/app/videos
      - ./output:/app/output
      - ./templates:/app/templates
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - OLLAMA_HOST=ollama:11434
  
  ollama:
    image: ollama/ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
```

### **APIæ¥å£è®¾è®¡**
```python
@app.post("/generate-iso-document")
async def generate_iso_document(
    video_file: UploadFile,
    metadata: ISOMetadata
):
    pipeline = ISODocumentPipeline()
    result = await pipeline.process(video_file, metadata.dict())
    
    return {
        "document_url": result['document_path'],
        "compliance_score": result['compliance_report']['score'],
        "generation_time": result['metadata']['processing_time']
    }
```

è¿™ä¸ªpipelineè®¾è®¡ç¡®ä¿äº†ä»è§†é¢‘è¾“å…¥åˆ°ISOæ–‡æ¡£è¾“å‡ºçš„å®Œæ•´è‡ªåŠ¨åŒ–æµç¨‹ï¼ŒåŒæ—¶ä¿æŒäº†é«˜åº¦çš„å¯é…ç½®æ€§å’Œæ‰©å±•æ€§ã€‚ä½ å¯ä»¥æ ¹æ®å…·ä½“çš„å·¥ä¸šç¯å¢ƒéœ€æ±‚è¿›è¡Œå®šåˆ¶åŒ–è°ƒæ•´ã€‚
